---
title: "AWS CLI ã® `sts get-session-token` ã§ 2FA ã‚’è¨­å®šã™ã‚‹ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [shell, aws]
published: true
---

# ã¯ã˜ã‚ã«

AWS IAM ã® 2FA ã‚’è¨­å®šã—ã¦ã¦ `aws-cli` ã‚’ä½¿ã†æ™‚ã‚‚ 2FA ã‚’åˆ©ç”¨ã—ãªã„ã¨ã„ã‘ãªã„å ´åˆã®ãŸã‚ã®ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

# ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼

```sh
aws sts get-session-token --serial-number "AWS_IAM_2FA_ã‚·ãƒªã‚¢ãƒ«ãƒŠãƒ³ãƒãƒ¼ã®ARN" --token-code "$(read v; echo $v)" \
    | jq -r '.Credentials | to_entries[] | [.key, .value] | join(" ")' \
    | sed "s/AccessKeyId/aws_access_key_id/;s/SecretAccessKey/aws_secret_access_key/;s/SessionToken/aws_session_token/; s/^/aws configure set --profile å–å¾—ã—ãŸèªè¨¼ã‚’ã‚»ãƒƒãƒˆã™ã‚‹profileå /" \
    | bash
```

å®Ÿè¡Œã—ã¦ã€2FAã®ã‚³ãƒ¼ãƒ‰ã‚’æ¨™æº–å…¥åŠ›ã«å…¥åŠ›ã™ã‚Œã° `aws --profile å–å¾—ã—ãŸèªè¨¼ã‚’ã‚»ãƒƒãƒˆã™ã‚‹profileå` ã§ 2FAèªè¨¼æ¸ˆã¿ã®ä¸Šæ™ºã§ AWS CLI ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

## ä»•çµ„ã¿

`aws sts get-session-token` ã§å–å¾—ã—ãŸèªè¨¼æƒ…å ±ã‚’ `aws configure set` ã§ `~/.aws/credentials` ã«æ›¸ãè¾¼ã‚“ã§ã„ã¾ã™ã€‚

# é–¢æ•°ã«ã—ãŸä¾‹

é–¢æ•°ã«ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```sh
function aws::renew::credentails() {
    local serial_number="AWS_IAM_2FA_ã‚·ãƒªã‚¢ãƒ«ãƒŠãƒ³ãƒãƒ¼ã®ARN"
    local out_aws_profile="å–å¾—ã—ãŸèªè¨¼ã‚’ã‚»ãƒƒãƒˆã™ã‚‹profileå"

    aws sts get-session-token --serial-number "${serial_number}" --token-code "$(read v; echo $v)" \
        | jq -r '.Credentials | to_entries[] | [.key, .value] | join(" ")' \
        | sed "s/AccessKeyId/aws_access_key_id/;s/SecretAccessKey/aws_secret_access_key/;s/SessionToken/aws_session_token/; s/^/aws configure set --profile ${out_aws_profile} /" \
        | bash
}
```

